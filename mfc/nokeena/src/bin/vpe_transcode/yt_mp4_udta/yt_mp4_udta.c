#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <sys/types.h>

#include "nkn_vpe_mp4_parser.h"
#include "nkn_vpe_bitio.h"
#include "nkn_vpe_types.h"
//#include "nkn_vpe_mp4_parser.h"
#include "nkn_vpe_mp4_seek_api.h"
#include "nkn_memalloc.h"
#include "nkn_mem_counter_def.h"


#define _DBG_DUMP_TABLES_

/*
 * BZ 8382
 *    This function is used to inject the udta box into MP4 file generated by MP4Box
 *    udta box is necessary for youtube video.
 *    1. read the moov box from the original MP4 file, obtain the moov size, offset
 *    2. parse the moov box to obtain all the trak box( stco box is necessary)
 *    3. generate the udta box,obtain the udta box size.
 *    4. inject the udta box at the end of moov box
 *    5. modify the moov box size, and also modify all the offset in stco box
 *    6. with the moov info in step 1, we can obtain the mdta box offset, size info
 *    7  copy the ftyp box into new MP4 file
 *    8. copy the modified  moov box(modified box size,modified stco box,injected
 *            udta box) into new MP4 file
 *    9. copy the entire mdta box into the new MP4 file
 */


/*
 * youtube udta box
 * udta box
 *    meta box
 *       hdrl  box
 *       ilist box
 *          gsst box      start time (it looks like this value is 0X30 all the youtube MP4)
 *          gstd box      duration time (mvhd->duration/mvhd->timescale*1000)
 *          gssd box      source data  (some strange values here, maybe the identifier?)
 *          gspu box      purl (data content should be all zeros)
 *          gspm box      pmsg (data content should be all zeros)
 *          gshh box      httphostheader
 *
 * size of youtube udta box
 * udta box               756
 *    meta box            748
 *       hdrl  box        33
 *       ilist box        703
 *          gsst box      25
 *          gstd box      30
 *          gssd box      56
 *          gspu box      152
 *          gspm box      152
 *          gshh box      280
 */

int32_t
main(int argc, char *argv[])
{
    FILE *fp, *fout;
    moov_t *moov; 
    size_t moov_offset, moov_size, mp4_size,
	mdat_offset, mdat_size, udta_size;
    char *data, *pre_pend;
    uint8_t *mdat, *p_udta;
    int32_t traks;
    int32_t  rv;

    /*initialization */
    fp = NULL;
    fout = NULL;
    moov = NULL;
    mdat = NULL;
    pre_pend = NULL;
    moov_offset = moov_size = 0;
    mdat_offset = mdat_size = 0;
    traks = 0;
    rv = 0;

    if (argc != 3) {
        printf("\nthere should be 2 parameters for program\n");
        return -1;
    }


    pre_pend = (char*)calloc(1, 32*1024);

    fp = fopen(argv[1], "rb");

    if(!fp) {
	printf("Error opening input file\n");
	return 0;
    }
    fseek(fp, 0, SEEK_END);
    mp4_size = ftell(fp);
    fseek(fp, 0, SEEK_SET);

    if(mp4_size <= 0) {
	printf("invalid file\n");
    }


    /* read first 32KB of data */
    fread(pre_pend, 1, 32*1024, fp);

    /* get moov offset and size */
    mp4_get_moov_info((uint8_t*)pre_pend, 32*1024, &moov_offset, &moov_size);

    if( (moov_offset == 0) ||
	(moov_size == 0) ) {
	printf("unable to find moov box in the first 32KB, this file may not be  PDL compliant\n");
	free(pre_pend);
	fclose(fp);
	return -1;
    }

    /* read the MOOV box */
    fseek(fp,moov_offset, SEEK_SET);
    data = (char*)calloc(1, moov_size);
    fread(data, 1, moov_size, fp);

    /* initialize the moov box */
    moov = mp4_init_moov((uint8_t*)data, moov_offset, moov_size);

    /* populate the STBL boxes for the VIDEO TRAK */
    traks = mp4_populate_trak(moov);
    if( (traks <= 0) ||
	(traks > 4) ){
	printf("invalid number of traks (0<=TRAKS<=4)\n");
	free(pre_pend);
	free(data);
	fclose(fp);
	return -1;
    }

    mdat_offset = moov_offset + moov_size;

    mp4_yt_create_udta(moov);
    mp4_get_modified_udta(moov, &p_udta, &udta_size);
    mp4_modify_moov(moov, udta_size);

    fout = fopen(argv[2], "wb");
    fwrite(pre_pend, 1, moov_offset, fout);
    /* write the modified  MOOV output box */
    fwrite(moov->data, 1, moov->size, fout);
    fwrite(p_udta, 1, udta_size, fout);

    mdat = (uint8_t*)malloc(mp4_size - mdat_offset);
    fseek(fp, mdat_offset, SEEK_SET);
    fread(mdat, 1, mp4_size - mdat_offset, fp);
    fwrite(mdat, 1, mp4_size - mdat_offset, fout);


    /*cleanup the moov box */
    mp4_moov_cleanup(moov, traks);
    fclose(fp);
    fclose(fout);
    free(pre_pend);
    free(data);
    free(mdat);
    /*
    {
	FILE *f1, *f2;
	int32_t v1, v2, i;

	i = 0;
	f1 = fopen("/home/sunil/data/stco_ref_v", "rb");
	f2 = fopen("/home/sunil/data/stco_v", "rb");
	while(!feof(f1)) {
	    fread(&v1, 1, 4, f1);
	    v1 = nkn_vpe_swap_uint32(v1);
	    fread(&v2, 1, 4, f2);
	    v2 = nkn_vpe_swap_uint32(v2);
	    if(i == 179) {
		int uu  = 0;
		uu++;
	    }
	    printf("diff %d entry no %d\n", v2-v1, i);
	    i++;
	}
	fclose(f1);
	fclose(f2);
    }
    */
    return 0;
}
